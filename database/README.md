# 智学奇境数据库设计文档

## 📊 数据库概览

- **数据库名称**: `zhixue_db`
- **核心理念**: 通过精细化的数据结构，支持AI驱动的个性化学习、游戏化体验和全面的学习行为追踪。
- **主要组成**: 14个核心表（含分区子表共15张），2个视图，以及多个函数和触发器。

---

## 🏗️ 核心表结构

### 1. 用户系统 (3张表)
- `users`: 存储用户的基础信息，如用户名、邮箱、年级等。
- `user_profiles`: 记录用户的学习档案，包括当前难度、学习时长、等级等。
- `user_grade_history`: 追踪用户年级的变化历史。

### 2. 题库系统 (3张表)
- `knowledge_points`: 定义了层级化的知识点体系。
- `questions`: 存储所有数学题目的详细信息，包括内容、难度、类型和答案解析。
- `question_knowledge_points`: 题目与知识点的多对多关联表。

### 3. 学习行为 (2张表+1分区子表)
- `answer_records`: 记录用户的每一次答题行为。**此表为分区表**，按时间分区以优化性能。
- `answer_records_default`: answer_records的默认分区子表（PostgreSQL自动生成，计入总表数）。
- `learning_sessions`: 跟踪用户的学习会话，记录会话时长、答题数等。

### 4. AI系统 (1张表)
- `difficulty_adjustments`: 记录AI对用户学习难度的每一次调整。

### 5. 游戏化系统 (4张表)
- `rewards`: 定义奖励类型及内容。
- `tasks`: 定义任务类型及内容。
- `user_tasks`: 记录用户的任务完成情况。
- `user_rewards`: 记录用户获得的奖励。

### 6. 系统配置 (1张表)
- `system_configs`: 存储系统级的动态配置项。

---

## 🔍 数据库视图（可选/规划中）

> 说明：以下视图为后续数据分析或后台统计需求的规划，目前数据库未实际创建。

- `user_statistics`：聚合用户的核心学习统计数据，提供全面的用户画像。
- `question_statistics`：聚合题目的统计数据，如使用次数、正确率、平均答题时间等。

---

## 🚀 关键设计与性能优化

- **分区表**: 核心的 `answer_records` 表按创建时间 (`created_at`) 进行范围分区，确保在高写入负载下依然保持高性能查询，便于数据管理和归档。
- **全面的索引**: 针对高频查询场景设计了优化的单列及复合索引，提升查询效率。
- **全文搜索**: 对 `questions` 表的题干和内容建立了全文搜索索引，支持快速的内容检索。
- **自动化机制**: 使用触发器自动更新记录的 `updated_at` 时间戳，简化应用层逻辑。

---

## 🔧 函数与存储过程

- `update_user_profile()`: 在用户答题后，调用此函数以高效更新用户的学习统计数据。
- `update_updated_at_column()`: 自动维护记录更新时间的触发器函数。
