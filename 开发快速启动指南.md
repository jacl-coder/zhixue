# 智学奇境 - 开发快速启动指南

## 技术栈

### 后端服务 (Golang)
- **Gin框架**: HTTP RESTful API服务，处理用户认证、数据管理等
- **Nano框架**: 高性能游戏服务器，处理实时游戏通信和会话管理
- **GORM**: 数据库ORM，PostgreSQL操作
- **Redis**: 缓存和会话存储
- **JWT**: 用户认证
- **Zap**: 结构化日志系统

### AI推理服务 (Python)
- **FastAPI**: 异步API框架，提供AI推理接口
- **Loguru**: 现代化日志系统
- **PyTorch**: 深度学习模型 (规划中)
- **Scikit-learn**: 机器学习算法 (规划中)

### 数据存储
- **PostgreSQL**: 主数据库，用户数据、学习记录
- **Redis**: 缓存层，会话数据、实时状态

## 服务架构

```
┌─────────────────┐    ┌─────────────────┐
│   Unity客户端    │    │   Web管理端     │
│                │    │                │
└─────────┬───────┘    └─────────┬───────┘
          │                      │
          └──────────┬───────────┘
                     │
          ┌─────────────────────────┐
          │     负载均衡/反向代理      │
          └─────────┬───────────────┘
                    │
    ┌───────────────┼───────────────┐
    │               │               │
┌───▼───┐      ┌────▼────┐      ┌───▼───┐
│Gin API│      │Nano游戏 │      │FastAPI│
│:8001  │      │服务器   │      │AI服务 │
│       │      │:8002    │      │:8003  │
└───┬───┘      └────┬────┘      └───┬───┘
    │               │               │
    └───────────────┼───────────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
    ┌───▼───┐   ┌───▼───┐   ┌───▼───┐
    │PostgreSQL  │Redis  │  │日志文件│
    │:5432   │   │:6379  │  │系统   │
    └───────┘    └───────┘   └───────┘
```

### 服务职责
- **Gin API (8001)**: 处理HTTP请求，用户认证，数据管理
- **Nano游戏服务器 (8002)**: 实时游戏通信，会话管理，WebSocket连接
- **FastAPI AI服务 (8003)**: AI推理，难度调节，个性化推荐

## 环境搭建（Ubuntu Server 22.04 Root用户）

### 1. 一键环境安装
```bash
# 下载脚本
wget https://your-server.com/ubuntu-server-setup.sh
# 或上传脚本到服务器

# 执行安装
chmod +x ubuntu-server-setup.sh
./ubuntu-server-setup.sh
```

### 2. 环境激活
```bash
# 重新加载环境变量 (zsh)
source /root/.zshrc

# 验证安装
go version
python3 --version
psql --version
redis-cli ping
```

## 快速开发

### 项目目录结构
```
/root/zhixue/
├── backend/          # Go后端服务 (Gin + Nano)
│   ├── cmd/
│   │   ├── server/   # Gin HTTP API服务
│   │   │   └── main.go
│   │   └── game/     # Nano游戏服务器
│   │       └── main.go
│   ├── internal/     # 内部模块
│   │   ├── api/      # API路由和中间件
│   │   ├── config/   # 配置管理
│   │   ├── database/ # 数据库连接
│   │   └── service/  # 业务逻辑
│   └── go.mod        # Go模块配置
├── ai-service/       # Python AI服务
│   ├── main.py      # AI服务入口 (FastAPI)
│   ├── venv/        # Python虚拟环境
│   └── requirements.txt # Python依赖
├── database/         # 数据库脚本
│   ├── init_db.sh   # 数据库初始化
│   └── init_postgresql.sql
├── start.sh         # 一键启动脚本
└── stop.sh          # 一键停止脚本
```

### 3. 启动服务

#### 🚀 参数化启动脚本（推荐）
```bash
# 进入项目目录
cd /root/zhixue

# 启动所有服务
./start.sh          # 默认启动所有服务
./start.sh all      # 启动所有服务

# 启动单个服务
./start.sh backend  # 仅启动后端API服务 (Gin+Nano中的Gin部分)
./start.sh game     # 仅启动游戏服务器 (Nano)
./start.sh ai       # 仅启动AI服务 (FastAPI)

# 停止服务
./stop.sh           # 停止所有服务
./stop.sh all       # 停止所有服务
./stop.sh backend   # 仅停止后端服务
./stop.sh game      # 仅停止游戏服务器
./stop.sh ai        # 仅停止AI服务

# 查看帮助
./start.sh --help   # 查看启动脚本帮助
./stop.sh --help    # 查看停止脚本帮助
```

#### 🔧 手动启动（开发调试）
```bash
# 终端1 - 启动Go后端API服务 (Gin)
cd /root/zhixue/backend
go run cmd/server/main.go

# 终端2 - 启动游戏服务器 (Nano)
cd /root/zhixue/backend
go run cmd/game/main.go

# 终端3 - 启动AI服务 (FastAPI)
cd /root/zhixue/ai-service
source venv/bin/activate
python main.py
```

### 4. 服务验证
```bash
# 后端API服务健康检查 (Gin)
curl http://localhost:8001/health

# AI服务健康检查 (FastAPI)
curl http://localhost:8003/health

# 游戏服务器状态检查 (Nano)
# 游戏服务器运行在端口 8002，提供WebSocket连接
netstat -tlnp | grep 8002
```

## 🚀 启动脚本详细说明

### 脚本特性
- **参数化支持**: 可启动/停止全部或单个服务
- **健康检查**: 自动验证服务启动状态
- **PID管理**: 记录进程ID，支持优雅停止
- **重复启动检查**: 防止重复启动相同服务
- **日志管理**: 自动创建日志文件，保留历史日志
- **错误处理**: 友好的错误信息和使用提示

### 启动流程
1. **环境检查**: 验证目录、依赖、虚拟环境
2. **重复检查**: 检查服务是否已在运行
3. **服务启动**: 后台启动对应服务进程
4. **PID记录**: 将进程ID保存到PID文件
5. **健康检查**: 通过HTTP接口验证服务状态
6. **状态显示**: 显示服务信息和管理命令

### 停止流程
1. **优雅停止**: 先发送TERM信号
2. **强制停止**: 2秒后如果未停止则发送KILL信号
3. **端口清理**: 检查并清理占用相关端口的进程
4. **文件清理**: 删除PID文件，保留日志文件

### 日志文件位置
```bash
/root/zhixue/logs/
├── backend.log    # 后端API服务日志
├── game.log       # 游戏服务器日志
├── ai.log         # AI服务日志
├── backend.pid    # 后端服务PID
├── game.pid       # 游戏服务器PID
└── ai.pid         # AI服务PID
```

### 常用命令组合
```bash
# 开发流程
./stop.sh all       # 停止所有服务
./start.sh all      # 启动所有服务

# 单服务调试
./stop.sh backend   # 停止后端服务
./start.sh backend  # 启动后端服务
tail -f logs/backend.log  # 查看实时日志

# 服务重启
./stop.sh ai && ./start.sh ai  # 重启AI服务

# 状态检查
curl http://localhost:8001/health && curl http://localhost:8003/health
netstat -tlnp | grep -E '(8001|8003|8002)'  # 检查所有端口

# 日志管理
tail -f logs/ai.log          # 实时查看AI服务日志
tail -n 100 logs/backend.log # 查看后端服务最近100行日志
grep "ERROR" logs/*.log      # 搜索所有日志中的错误信息
# 注意：停止服务时不会自动清除日志文件，需要手动清理
```

## 开发建议

### 代码结构推荐
```
backend/
├── cmd/
│   ├── server/      # Gin HTTP API服务
│   │   └── main.go  # REST API入口
│   └── game/        # Nano游戏服务器
│       └── main.go  # 实时游戏服务入口
├── internal/
│   ├── api/
│   │   ├── handlers/    # API处理器
│   │   ├── middleware/  # 中间件 (日志、认证等)
│   │   └── routes/      # 路由定义
│   ├── config/      # 配置管理
│   ├── database/    # 数据库连接和模型
│   ├── redis/       # Redis缓存
│   ├── service/     # 业务逻辑层
│   └── game/        # 游戏逻辑
├── models/          # 数据模型
├── pkg/            # 公共包
└── configs/        # 配置文件

ai-service/
├── main.py         # FastAPI入口
├── models/         # AI模型
├── api/           # API接口
├── logger_config.py # 日志配置
└── data/          # 数据处理
```

### 数据库配置
- **PostgreSQL**: 
  - 数据库: `zhixue_db`
  - 用户: `zhixue_user`
  - 密码: `1024`
  - 端口: `5432`

- **Redis**: 
  - 端口: `6379`
  - 无密码

### 端口分配
- **后端API服务 (Gin)**: `8001`
- **游戏服务器 (Nano)**: `8002`
- **AI服务 (FastAPI)**: `8003`
- **数据库**: `5432` (PostgreSQL)
- **缓存**: `6379` (Redis)

## MVP开发优先级

### 第一阶段（核心功能）
1. 用户注册登录系统
2. 数学题库管理
3. AI难度调节基础算法
4. 简单的游戏化界面

### 第二阶段（游戏化）
1. 2.5D数学王国场景
2. 角色成长系统
3. 成就奖励机制
4. 学习路径推荐

### 第三阶段（AI增强）
1. 个性化学习分析
2. 智能题目生成
3. 学习行为预测
4. 自适应难度优化

## 常用命令

### Go开发
```bash
# 进入后端目录
cd /root/zhixue/backend

# 安装依赖
go mod tidy

# 运行API服务 (开发模式)
go run cmd/server/main.go

# 运行游戏服务器 (开发模式)
go run cmd/game/main.go

# 热重载开发 (需要安装air)
go install github.com/cosmtrek/air@latest
air -c cmd/server/.air.toml  # API服务热重载
air -c cmd/game/.air.toml    # 游戏服务器热重载

# 构建生产版本
go build -o zhixue-server cmd/server/main.go
go build -o zhixue-game cmd/game/main.go
```

### Python开发
```bash
# 激活环境
source venv/bin/activate

# 安装包
pip install package-name

# 热重载开发
uvicorn main:app --reload --host 0.0.0.0 --port 8003
```

### 数据库操作
```bash
# 连接数据库
psql -h localhost -U zhixue_user -d zhixue_db
# 输入密码: 1024

# 备份数据库
pg_dump -h localhost -U zhixue_user zhixue_db > backup.sql

# 查看Redis (无需密码)
redis-cli
keys *
```

## 故障排除

### 常见问题
1. **Go命令未找到**: 执行 `source /root/.zshrc`
2. **Python虚拟环境问题**: 重新创建 `python3 -m venv venv`
3. **数据库连接失败**: 检查PostgreSQL服务状态，确认密码为1024
4. **端口占用**: 使用 `netstat -tlnp` 查看端口占用
5. **Redis连接失败**: 检查Redis服务状态 `systemctl status redis-server`
6. **游戏服务器连接问题**: 确认Nano服务运行在8002端口，检查WebSocket连接

### 重置环境
```bash
# 重置数据库
sudo -u postgres dropdb zhixue_db
sudo -u postgres createdb zhixue_db

# 重置Python环境
rm -rf /root/zhixue/ai-service/venv
cd /root/zhixue/ai-service
python3 -m venv venv
source venv/bin/activate
pip install fastapi uvicorn
```

---

**🎯 开发目标**: 2026年中国大学生计算机设计大赛人工智能应用类获奖作品

**📅 开发时间线**: 建议6个月MVP开发周期，3个月完善优化
